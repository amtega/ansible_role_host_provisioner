---
# Tasks for testing role

- import_playbook: cleanup.yml

- name: Setup testing configuration
  hosts: >-
    {{ host_provisioner_testing_backends_host
       | default(host_provisioner_testing_single_host) }}
  tasks:
    - name: Setup testing virtual machines list
      set_fact:
        host_provisioner_vmware_vms: "{{ host_provisioner_testing_vms }}"

- name: Cleanup stalled hosts and provisione the new ones
  hosts: >-
    {{ host_provisioner_testing_backends_host
       | default(host_provisioner_testing_single_host) }}
  roles:
    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: cleanup_stalled

    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: provisione

- name: Setup dhcp entries for provisioned hosts
  hosts: >-
    {{ host_provisioner_testing_dhcpd_host
       | default(host_provisioner_testing_single_host) }}
  roles:
    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: setup_dhcp

- name: Setup cobbler entities for provisioned hosts
  hosts: >-
    {{ host_provisioner_testing_cobbler_host
       | default(host_provisioner_testing_single_host) }}
  roles:
    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: setup_cobbler

- name: Install new provisioned hosts
  hosts: >-
    {{ host_provisioner_testing_backends_host
       | default(host_provisioner_testing_single_host) }}
  roles:
    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: install

- name: Inventory new provisioned hosts
  hosts: >-
    {{ host_provisioner_testing_backends_host
       | default(host_provisioner_testing_single_host) }}
  roles:
    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: inventory

- name: Wait for new provisioned hosts to be installed
  hosts: >-
    {{ host_provisioner_testing_backends_host
       | default(host_provisioner_testing_single_host) }}
  roles:
    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: wait

- name: Start configuration of new provisioned hosts
  hosts: >-
    {{ hostvars[host_provisioner_testing_backends_host
                | default(host_provisioner_testing_single_host)]
       .host_provisioner_group }}
  gather_facts: no
  roles:
    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: configure_start

- name: End configuration of new provisioned hosts
  hosts: >-
    {{ hostvars[host_provisioner_testing_backends_host
                | default(host_provisioner_testing_single_host)]
       .host_provisioner_group }}
  gather_facts: no
  roles:
    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: configure_end

- name: Finalize provisioned hosts
  hosts: >-
    {{ host_provisioner_testing_backends_host
       | default(host_provisioner_testing_single_host) }}
  roles:
    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: finalize

- name: Cleanup dhcp entries used to provisione hosts
  hosts: >-
    {{ host_provisioner_testing_dhcpd_host
       | default(host_provisioner_testing_single_host) }}
  roles:
    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: cleanup_dhcp

- name: Cleanup cobbler entries used to provisione hosts
  hosts: >-
    {{ host_provisioner_testing_cobbler_host
       | default(host_provisioner_testing_single_host) }}
  roles:
    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: cleanup_cobbler

- import_playbook: cleanup.yml
