---
# Tasks for testing role

- name: Setup testing configuration
  tasks:
    - name: Setup testing virtual machine config
      set_fact:
        vmware_provisioner_vm:
          name: >-
            {{ host_provisioner_testing_vm_name
               | default("host-provisioner-testing-vm") }}
          annotation: >_
            {{ host_provisioner_testing_vm_annotation
               | default("Ansible host_provisioner role testing machine") }}
          folder: {{ host_provisioner_testing_vm_folder | default("/") }}
          datacenter: "{{ host_provisioner_testing_vm_datacenter }}"
          cluster: "{{ host_provisioner_testing_vm_cluster }}"
          guest_id: "{{ host_provisioner_testing_vm_guest_id }}"
          disk:
            - size_gb: >-
                {{ host_provisioner_testing_vm_disk_size | default(30) }}
              type: >-
                {{ host_provisioner_testing_vm_disk_type | default("thin") }}
              datastore: >-
                {{ host_provisioner_testing_vm_datastore }}
          hardware:
            memory_mb: >-
              {{ host_provisioner_testing_vm_memory_mb | default(2048) }}
            num_cpus: >-
              {{ host_provisioner_testing_vm_num_cpus | default(1) }}
            num_cpu_cores_per_socket: >-
              {{ host_provisioner_testing_vm_num_cpu_cores_per_socket
                 | default(1) }}
          networks:
            - name: "{{ host_provisioner_testing_vm_net_name }}"
              device_type: >-
                {{ host_provisioner_testing_vm_net_type | default("vmxnet3") }}
          wait_for_ip_address: no
          force: yes
          state: poweredon

        network_interfaces_gateway: >_
          {{ host_provisioner_testing_vm_net_gateway }}
        network_interfaces:
          - logicalname: >-
              {{ host_provisioner_testing_vm_net_logicalname| default("eth0") }}
            ipv4:
              - address: "{{ host_provisioner_testing_vm_net_address }}"
                cidr: "{{ host_provisioner_testing_vm_net_cidr }}"

- name: Cleanup stalled hosts and provisione the new ones
  hosts: "{{ backends_host | default(single_host) }}"
  roles:
    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: cleanup_stalled

    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: provisione

- name: Setup dhcp entries for provisioned hosts
  hosts: "{{ dhcpd_host | default(single_host) }}"
  roles:
    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: setup_dhcp

- name: Setup cobbler entities for provisioned hosts
  hosts: "{{ cobbler_host | default(single_host) }}"
  roles:
    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: setup_cobbler

- name: Install new provisioned hosts
  hosts: "{{ backends_host | default(single_host) }}"
  roles:
    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: install

- name: Inventory new provisioned hosts
  hosts: "{{ backends_host | default(single_host) }}"
  roles:
    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: inventory

- name: Wait for new provisioned hosts to be installed
  hosts: "{{ backends_host | default(single_host) }}"
  roles:
    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: wait

- name: Start configuration of new provisioned hosts
  hosts: "{{ hostvars[backends_host].host_provisioner_group }}"
  gather_facts: no
  roles:
    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: configure_start

- name: Start configuration of new provisioned hosts
  hosts: "{{ hostvars[backends_host].host_provisioner_group }}"
  gather_facts: no
  roles:
    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: configure_start

- name: End configuration of new provisioned hosts
  hosts: "{{ hostvars[backends_host].host_provisioner_group }}"
  gather_facts: no
  roles:
    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: configure_end

- name: Finalize provisioned hosts
  hosts: "{{ backends_host | default(single_host) }}"
  roles:
    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: finalize

- name: Cleanup dhcp entries used to provisione hosts
  hosts: "{{ dhcpd_host | default(single_host) }}"
  roles:
    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: cleanup_dhcp

- name: Cleanup cobbler entries used to provisione hosts
  hosts: "{{ cobbler_host | default(single_host) }}"
  roles:
    - role: amtega.host_provisioner
      vars:
        host_provisioner_stage: cleanup_cobbler
